SkyGameServer.RankModel=OBJECT({preset:()=>{return SkyGameServer.MODEL},params:()=>{let e={name:{notEmpty:!0,size:{max:255}},point:{notEmpty:!0,integer:!0}};return{name:"Rank",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}});SkyGameServer.MAIN=METHOD({run:e=>{let o=SkyGameServer.LOG_DB("invalidPurchaseLogDB"),n=SkyGameServer.LOG_DB("validPurchaseLogDB");e((e,t)=>{let r=e.uri,i=e.method,c=e.params;if("rank/save"===r)return"POST"===i?void 0!==c.name&&c.key===SHA256({password:c.name,key:NODE_CONFIG.SkyGameServer.secureKey})?SkyGameServer.RankModel.create({name:c.name,point:c.point},{notValid:()=>{t({statusCode:400,headers:{"Access-Control-Allow-Origin":"*"}})},success:e=>{SkyGameServer.RankModel.count({filter:{point:{$gt:e.point}}},e=>{t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:e+1})})}}):t({statusCode:400,headers:{"Access-Control-Allow-Origin":"*"}}):t({statusCode:404,headers:{"Access-Control-Allow-Origin":"*"}}),!1;if("rank/list"===r)return SkyGameServer.RankModel.find({sort:{point:-1},count:void 0===c.count?100:c.count},e=>{t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:JSON.stringify({list:e})})}),!1;if("validatepurchase/android"===r){let e=c.productId,r=c.purchaseToken;return void 0!==e&&void 0!==r&&UIAP.GOOGLE_PLAY_PURCHASE_VALIDATE({productId:e,purchaseToken:r},i=>{i!==!0?o.log({productId:e,purchaseToken:r}):n.log({productId:e,purchaseToken:r}),t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:JSON.stringify({productId:e,isValid:i})})}),!1}if("validatepurchase/ios"===r){let e=c.productId,r=c.purchaseReceipt;return void 0!==e&&void 0!==r&&UIAP.APP_STORE_PURCHASE_VALIDATE({productId:e,receipt:r},i=>{i!==!0?o.log({productId:e,purchaseReceipt:r}):n.log({productId:e,purchaseReceipt:r}),t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:JSON.stringify({productId:e,isValid:i})})}),!1}})}});