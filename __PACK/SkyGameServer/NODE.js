SkyGameServer.RankModel=OBJECT({preset:()=>{return SkyGameServer.MODEL},params:()=>{let e={name:{notEmpty:!0,size:{max:255}},point:{notEmpty:!0,integer:!0}};return{name:"Rank",methodConfig:{create:{valid:VALID(e)},update:!1,remove:!1}}}}),SkyGameServer("ROLE").ADMIN="Admin";SkyGameServer.AdminRoom=OBJECT({init:(e,n)=>{let o=SkyGameServer.DB("PushKey");SkyGameServer.ROOM("Admin",(e,n,i)=>{let t=()=>{return void 0!==e&&void 0!==e.roles&&CHECK_IS_IN({array:e.roles,value:SkyGameServer.ROLE.ADMIN})===!0};n("auth",(n,o)=>{n===NODE_CONFIG.SkyGameServer.adminPassword?(e.roles=[SkyGameServer.ROLE.ADMIN],o(n===NODE_CONFIG.SkyGameServer.adminPassword)):o(!1)}),n("sendPushMessage",e=>{void 0!==e&&t()===!0&&o.find({isFindAll:!0},EACH(n=>{void 0!==n.androidKey&&UPUSH.ANDROID_PUSH({regId:n.androidKey,data:{message:e.message}}),void 0!==n.iosKey&&UPUSH.IOS_PUSH({badge:1,token:n.iosKey,sound:"ping.aiff",message:e.message})}))})})}}),SkyGameServer.MAIN=METHOD({run:e=>{let n=SkyGameServer.LOG_DB("invalidPurchaseLogDB"),o=SkyGameServer.LOG_DB("validPurchaseLogDB"),i=SkyGameServer.DB("PushKey");e((e,t)=>{let s=e.uri,r=e.method,c=e.params;if("rank/save"===s)return"POST"===r?void 0!==c.name&&c.key===SHA256({password:c.name,key:NODE_CONFIG.SkyGameServer.secureKey})?SkyGameServer.RankModel.create({name:c.name,point:c.point},{notValid:()=>{t({statusCode:400,headers:{"Access-Control-Allow-Origin":"*"}})},success:e=>{SkyGameServer.RankModel.count({filter:{point:{$gt:e.point}}},e=>{t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:e+1})})}}):t({statusCode:400,headers:{"Access-Control-Allow-Origin":"*"}}):t({statusCode:404,headers:{"Access-Control-Allow-Origin":"*"}}),!1;if("rank/list"===s)return SkyGameServer.RankModel.find({sort:{point:-1},count:void 0===c.count?100:c.count},e=>{t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:JSON.stringify({list:e})})}),!1;if("validatepurchase/android"===s){if("POST"===r){let e=c.productId,i=c.purchaseToken;void 0!==e&&void 0!==i&&UIAP.GOOGLE_PLAY_PURCHASE_VALIDATE({productId:e,purchaseToken:i},s=>{s!==!0?n.log({productId:e,purchaseToken:i}):o.log({productId:e,purchaseToken:i}),t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:JSON.stringify({productId:e,isValid:s})})})}else t({statusCode:404,headers:{"Access-Control-Allow-Origin":"*"}});return!1}if("validatepurchase/ios"===s){if("POST"===r){let e=c.productId,i=c.purchaseReceipt;void 0!==e&&void 0!==i&&UIAP.APP_STORE_PURCHASE_VALIDATE({productId:e,receipt:i},s=>{s!==!0?n.log({productId:e,purchaseReceipt:i}):o.log({productId:e,purchaseReceipt:i}),t({contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"},content:JSON.stringify({productId:e,isValid:s})})})}else t({statusCode:404,headers:{"Access-Control-Allow-Origin":"*"}});return!1}if("savepushkey/android"===s){if("POST"===r){let e=c.pushKey;void 0!==e&&i.get({filter:{androidKey:e}},{notExists:()=>{i.create({androidKey:e},e=>{t({content:JSON.stringify(e),contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"}})})},success:e=>{t({content:JSON.stringify(e),contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"}})}})}else t({statusCode:404,headers:{"Access-Control-Allow-Origin":"*"}});return!1}if("savepushkey/ios"===s){if("POST"===r){let e=c.pushKey;void 0!==e&&i.checkExists({filter:{iosKey:e}},{notExists:()=>{i.create({iosKey:e},e=>{t({content:JSON.stringify(e),contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"}})})},success:e=>{t({content:JSON.stringify(e),contentType:"application/json",headers:{"Access-Control-Allow-Origin":"*"}})}})}else t({statusCode:404,headers:{"Access-Control-Allow-Origin":"*"}});return!1}})}});